<!--
Chemical structure renderer
based on canvas three.js / tween.js
v150715
author Evgeny Blokhin (eb@tilde.pro)
License: MIT
-->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta charset="utf-8">
<style>
body{margin:0;padding:0;overflow:hidden;background:#ccc;}
html, body{height:100%;}
#infopanel{position:absolute;top:20px;left:20px;width:150px;height:150px;text-align:left;z-index:100;line-height:22px;font-family:Arial;font-size:12px;}
#zoompanel{position:absolute;top:8px;right:8px;width:50px;height:150px;z-index:100;background:no-repeat url(data:image/gif;base64,R0lGODlhMgCWAJEAAAAAAP///8zMzP///yH5BAEAAAMALAAAAAAyAJYAAAL/3ISpae2+onj0yFjhXbltnH1cZ4kMZSpkCa7dtW7uC5PfjMr2jRtizJD0hKodwtcyFou0I3LUZDJDp+f0IfRUqU4tVPNlubZWchaM64LNYWTvwJ3k1JA3kGbP6/f8vv8PGCg4aCf3ImiIRYdWkTjmWNZ45TZDxsLWZjnneLaGCamo1hk6NUnqZerZlYpatig5wmp1+RoXpKnaBqQTlTTEayu767sp/EhMagKbMvwTDLzM0wtdXNNsTZitvc3d7f0NHi4+Tl7+59ydYqy3vp6G2wQIf9yHi/y0B3+PXwiqutvv2qM3tf4NrOQvWUJGd47N03DQYcFQDSUuVLTjlzsL/xnfbdR30eA7PK7USeNIBZVJdCglqVwJrOAqmMq0kKRFM4nMkC8JJpyo0OdNi0JTenzIcM5RoBA7Eh1pBKG7h0hpQQUokJ5WJUyr8ps2zOfCfV81grXFjilXtZvSHtHVTONMr7nOenK7Em2+mnb5wA1mzlVgnIFHiTMcjmy6v982bmNbjBwzbsgU45XK06Pbc5CV+s1cMWCgzpQQgS5BiC7pq6FT81xt1unji7CLDtUGEtxO3T8N5WS5u+TvLcFxDhfV++Vx5DeXdyruXGfyxtO97Ty9+Xa2ebV/YcXdFbvYrYO80tXsvXxnx1HysI/s/rxC8Zf63ZJv9Wn9+L6wRSDCO1k09ZwEWGGMWXfgYgnOtiB4DW73oGvvmdbdaHIUAAA7);}
#optionpanel{position:absolute;bottom:2px;left:0;width:100%;height:30px;z-index:100;text-align:center;font-family:Arial;font-size:12px;}
div.L{display:block;position:absolute;font-size:0.55em;z-index:200;font-family:Arial;}
</style>
<script type="text/javascript" src="three.custom.js"></script>
<!--script type="text/javascript" src="stats.min.js"></script-->
<script type="text/javascript" src="tween.min.js"></script>
<script type="text/javascript" src="math.min.js"></script>
</head>
<body id="body">
<!-- iframe id="file-process" name="file-process" width="1px" height="1px" src="" style="display:none;"></iframe -->
<script type="text/javascript">
/**
* Polyfills
*/
String.prototype.startswith = function(prefix){
    return this.indexOf(prefix) === 0;
}
String.prototype.endswith = function(searchString, position){
      var subjectString = this.toString();
      if (position === undefined || position > subjectString.length) position = subjectString.length;
      position -= searchString.length;
      var lastIndex = subjectString.indexOf(searchString, position);
      return lastIndex !== -1 && lastIndex === position;
}
String.prototype.trim = function(){
    return this.replace(/^\s+|\s+$/g, '');
}
// From https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/keys
if (!Object.keys) {
  Object.keys = (function() {
    'use strict';
    var hasOwnProperty = Object.prototype.hasOwnProperty,
        hasDontEnumBug = !({ toString: null }).propertyIsEnumerable('toString'),
        dontEnums = [
          'toString',
          'toLocaleString',
          'valueOf',
          'hasOwnProperty',
          'isPrototypeOf',
          'propertyIsEnumerable',
          'constructor'
        ],
        dontEnumsLength = dontEnums.length;

    return function(obj) {
      if (typeof obj !== 'object' && (typeof obj !== 'function' || obj === null)) {
        throw new TypeError('Object.keys called on non-object');
      }

      var result = [], prop, i;
      for (prop in obj) {
        if (hasOwnProperty.call(obj, prop)) {
          result.push(prop);
        }
      }

      if (hasDontEnumBug) {
        for (i = 0; i < dontEnumsLength; i++) {
          if (hasOwnProperty.call(obj, dontEnums[i])) {
            result.push(dontEnums[i]);
          }
        }
      }
      return result;
    };
  }());
}
/**
* TrackballControls by Eberhard Graether and Mark Lundin
* modified by EB
*/
THREE.TrackballControls = function ( object, domElement ) {
    var _this = this;
    var STATE = { NONE: -1, ROTATE: 0, ZOOM: 1, PAN: 2, TOUCH_ROTATE: 3, TOUCH_ZOOM_PAN: 4 };
    this.object = object;
    this.domElement = ( domElement !== undefined ) ? domElement : document;
    // API
    this.enabled = true;
    this.screen = { width: 0, height: 0, offsetLeft: 0, offsetTop: 0 };
    this.radius = ( this.screen.width + this.screen.height ) / 4;
    this.rotateSpeed = 1.5;
    this.zoomSpeed = 1.2;
    this.panSpeed = 0.3;
    this.noRotate = false;
    this.noZoom = false;
    this.noPan = false;
    this.staticMoving = false;
    this.dynamicDampingFactor = 0.2;
    this.minDistance = 0;
    this.maxDistance = Infinity;
    // internals
    this.target = new THREE.Vector3();
    var lastPosition = new THREE.Vector3();
    var _state = STATE.NONE,
    _prevState = STATE.NONE,
    _eye = new THREE.Vector3(),
    _rotateStart = new THREE.Vector3(),
    _rotateEnd = new THREE.Vector3(),
    _zoomStart = new THREE.Vector2(),
    _zoomEnd = new THREE.Vector2(),
    _touchZoomDistanceStart = 0,
    _touchZoomDistanceEnd = 0,
    _panStart = new THREE.Vector2(),
    _panEnd = new THREE.Vector2();
    // for reset
    this.target0 = this.target.clone();
    this.position0 = this.object.position.clone();
    this.up0 = this.object.up.clone();
    // events
    var changeEvent = { type: 'change' };
    // methods
    this.handleResize = function () {
        this.screen.width = window.innerWidth;
        this.screen.height = window.innerHeight;
        this.screen.offsetLeft = 0;
        this.screen.offsetTop = 0;
        this.radius = ( this.screen.width + this.screen.height ) / 4;
    };
    this.handleEvent = function ( event ) {
        if ( typeof this[ event.type ] == 'function' ) {
            this[ event.type ]( event );
        }
    };
    this.getMouseOnScreen = function ( clientX, clientY ) {
        return new THREE.Vector2(
            ( clientX - _this.screen.offsetLeft ) / _this.radius * 0.5,
            ( clientY - _this.screen.offsetTop ) / _this.radius * 0.5
        );
    };
    this.getMouseProjectionOnBall = function ( clientX, clientY ) {
        var mouseOnBall = new THREE.Vector3(
            ( clientX - _this.screen.width * 0.5 - _this.screen.offsetLeft ) / _this.radius,
            ( _this.screen.height * 0.5 + _this.screen.offsetTop - clientY ) / _this.radius,
            0.0
        );
        var length = mouseOnBall.length();
        if ( length > 1.0 ) {
            mouseOnBall.normalize();
        } else {
            mouseOnBall.z = Math.sqrt( 1.0 - length * length );
        }
        _eye.copy( _this.object.position ).sub( _this.target );
        var projection = _this.object.up.clone().setLength( mouseOnBall.y );
        projection.add( _this.object.up.clone().cross( _eye ).setLength( mouseOnBall.x ) );
        projection.add( _eye.setLength( mouseOnBall.z ) );
        return projection;
    };
    this.rotateCamera = function () {
        var angle = Math.acos( _rotateStart.dot( _rotateEnd ) / _rotateStart.length() / _rotateEnd.length() );
        if ( angle ) {
            var axis = ( new THREE.Vector3() ).crossVectors( _rotateStart, _rotateEnd ).normalize(),
                quaternion = new THREE.Quaternion();
            angle *= _this.rotateSpeed;
            quaternion.setFromAxisAngle( axis, -angle );
            _eye.applyQuaternion( quaternion );
            _this.object.up.applyQuaternion( quaternion );
            _rotateEnd.applyQuaternion( quaternion );
            if ( _this.staticMoving ) {
                _rotateStart.copy( _rotateEnd );
            } else {
                quaternion.setFromAxisAngle( axis, angle * ( _this.dynamicDampingFactor - 1.0 ) );
                _rotateStart.applyQuaternion( quaternion );
            }
        }
    };
    this.zoomCamera = function () {
        if ( _state === STATE.TOUCH_ZOOM ) {
            var factor = _touchZoomDistanceStart / _touchZoomDistanceEnd;
            _touchZoomDistanceStart = _touchZoomDistanceEnd;
            _eye.multiplyScalar( factor );
        } else {
            var factor = 1.0 + ( _zoomEnd.y - _zoomStart.y ) * _this.zoomSpeed;
            if ( factor !== 1.0 && factor > 0.0 ) {
                _eye.multiplyScalar( factor );
                if ( _this.staticMoving ) {
                    _zoomStart.copy( _zoomEnd );
                } else {
                    _zoomStart.y += ( _zoomEnd.y - _zoomStart.y ) * this.dynamicDampingFactor;
                }
            }
        }
    };
    this.panCamera = function () {
        var mouseChange = _panEnd.clone().sub( _panStart );
        if ( mouseChange.lengthSq() ) {
            mouseChange.multiplyScalar( _eye.length() * _this.panSpeed );
            var pan = _eye.clone().cross( _this.object.up ).setLength( mouseChange.x );
            pan.add( _this.object.up.clone().setLength( mouseChange.y ) );
            _this.object.position.add( pan );
            _this.target.add( pan );
            if ( _this.staticMoving ) {
                _panStart = _panEnd;
            } else {
                _panStart.add( mouseChange.subVectors( _panEnd, _panStart ).multiplyScalar( _this.dynamicDampingFactor ) );
            }
        }
    };
    this.checkDistances = function () {
        if ( !_this.noZoom || !_this.noPan ) {
            if ( _this.object.position.lengthSq() > _this.maxDistance * _this.maxDistance ) {
                _this.object.position.setLength( _this.maxDistance );
            }
            if ( _eye.lengthSq() < _this.minDistance * _this.minDistance ) {
                _this.object.position.addVectors( _this.target, _eye.setLength( _this.minDistance ) );
            }
        }
    };
    this.update = function () {
        _eye.subVectors( _this.object.position, _this.target );
        if ( !_this.noRotate ) {
            _this.rotateCamera();
        }
        if ( !_this.noZoom ) {
            _this.zoomCamera();
        }
        if ( !_this.noPan ) {
            _this.panCamera();
        }
        _this.object.position.addVectors( _this.target, _eye );
        _this.checkDistances();
        _this.object.lookAt( _this.target );
        if ( lastPosition.distanceToSquared( _this.object.position ) > 0.000001 ) {
            _this.dispatchEvent( changeEvent );
            lastPosition.copy( _this.object.position );
        }
    };
    this.reset = function () {
        _state = STATE.NONE;
        _prevState = STATE.NONE;
        _this.target.copy( _this.target0 );
        _this.object.position.copy( _this.position0 );
        _this.object.up.copy( _this.up0 );
        _eye.subVectors( _this.object.position, _this.target );
        _this.object.lookAt( _this.target );
        _this.dispatchEvent( changeEvent );
        lastPosition.copy( _this.object.position );
    };
    // listeners
    function mousedown( event ) {
        if ( _this.enabled === false ) return;
        event.preventDefault();
        event.stopPropagation();

        if (!window.active_renderer) window.active_renderer = requestAnimationFrame(vivify);

        if ( _state === STATE.NONE ) {
            _state = event.button;
        }
        if ( _state === STATE.ROTATE && !_this.noRotate ) {
            _rotateStart = _rotateEnd = _this.getMouseProjectionOnBall( event.clientX, event.clientY );
        } else if ( _state === STATE.ZOOM && !_this.noZoom ) {
            _zoomStart = _zoomEnd = _this.getMouseOnScreen( event.clientX, event.clientY );
        } else if ( _state === STATE.PAN && !_this.noPan ) {
            _panStart = _panEnd = _this.getMouseOnScreen( event.clientX, event.clientY );
        }
        document.addEventListener( 'mousemove', mousemove, false );
        document.addEventListener( 'mouseup', mouseup, false );
        remove_2D_labels();
    }
    function mousemove( event ) {
        if ( _this.enabled === false ) return;
        event.preventDefault();
        event.stopPropagation();
        if ( _state === STATE.ROTATE && !_this.noRotate ) {
            _rotateEnd = _this.getMouseProjectionOnBall( event.clientX, event.clientY );
        } else if ( _state === STATE.ZOOM && !_this.noZoom ) {
            _zoomEnd = _this.getMouseOnScreen( event.clientX, event.clientY );
        } else if ( _state === STATE.PAN && !_this.noPan ) {
            _panEnd = _this.getMouseOnScreen( event.clientX, event.clientY );
        }
    }
    function mouseup( event ) {
        if ( _this.enabled === false ) return;
        event.preventDefault();
        event.stopPropagation();
        _state = STATE.NONE;

        if (!window.active_tween) { cancelAnimationFrame(window.active_renderer); window.active_renderer = false; }

        document.removeEventListener( 'mousemove', mousemove );
        document.removeEventListener( 'mouseup', mouseup );
        add_2D_labels();
    }
    function touchstart( event ) {
        if ( _this.enabled === false ) return;

        if (!window.active_renderer) window.active_renderer = requestAnimationFrame(vivify);

        switch ( event.touches.length ) {
            case 1:
                _state = STATE.TOUCH_ROTATE;
                _rotateStart = _rotateEnd = _this.getMouseProjectionOnBall( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY );
                break;
            case 2:
                _state = STATE.TOUCH_ZOOM_PAN;
                var dx = event.touches[ 0 ].pageX - event.touches[ 1 ].pageX;
                var dy = event.touches[ 0 ].pageY - event.touches[ 1 ].pageY;
                _touchZoomDistanceEnd = _touchZoomDistanceStart = Math.sqrt( dx * dx + dy * dy );

                var x = ( event.touches[ 0 ].pageX + event.touches[ 1 ].pageX ) / 2;
                var y = ( event.touches[ 0 ].pageY + event.touches[ 1 ].pageY ) / 2;
                _panStart = _panEnd = _this.getMouseOnScreen( x, y );
                break;
            default:
                _state = STATE.NONE;
        }
        remove_2D_labels();
    }
    function touchmove( event ) {
        if ( _this.enabled === false ) return;
        event.preventDefault();
        event.stopPropagation();

        switch ( event.touches.length ) {
            case 1:
                _rotateEnd = _this.getMouseProjectionOnBall( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY );
                break;
            case 2:
                var dx = event.touches[ 0 ].pageX - event.touches[ 1 ].pageX;
                var dy = event.touches[ 0 ].pageY - event.touches[ 1 ].pageY;
                _touchZoomDistanceEnd = Math.sqrt( dx * dx + dy * dy );

                var x = ( event.touches[ 0 ].pageX + event.touches[ 1 ].pageX ) / 2;
                var y = ( event.touches[ 0 ].pageY + event.touches[ 1 ].pageY ) / 2;
                _panEnd = _this.getMouseOnScreen( x, y );
                break;
            default:
                _state = STATE.NONE;
        }
    }
    function touchend( event ) {
        if ( _this.enabled === false ) return;
        switch ( event.touches.length ) {
            case 1:
                _rotateEnd = _rotateStart = _this.getMouseProjectionOnBall( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY );
                break;
            case 2:
                _touchZoomDistanceStart = _touchZoomDistanceEnd = 0;

                var x = ( event.touches[ 0 ].pageX + event.touches[ 1 ].pageX ) / 2;
                var y = ( event.touches[ 0 ].pageY + event.touches[ 1 ].pageY ) / 2;
                _panEnd = _panStart = _this.getMouseOnScreen( x, y );
                break;
        }

        if (!window.active_tween) { cancelAnimationFrame(window.active_renderer); window.active_renderer = false; }

        _state = STATE.NONE;
        add_2D_labels();
    }
    this.domElement.addEventListener( 'mousedown', mousedown, false );
    this.domElement.addEventListener( 'touchstart', touchstart, false );
    this.domElement.addEventListener( 'touchend', touchend, false );
    this.domElement.addEventListener( 'touchmove', touchmove, false );
    this.handleResize();
};
THREE.TrackballControls.prototype = Object.create( THREE.EventDispatcher.prototype );
/**
* Three.js invocation
*/
var container, stats, camera, scene, renderer, controls, atoms;
var forced_labels = false, active_overlay = "", overlay_backup = "", loaded_3D = false, obj_3D = false;

//var sample = '{"atoms": [{"x": "0", "y": "0", "z": "0", "c": "0x000000", "r": "1.25", "o": {"m": 42, "mm": -0.0022, "t": "Uuo"}}, {"x": "1.25", "y": "1.25", "z": "1.25", "c": "0xFF0000", "r": "1", "o": {"m": 8, "t": "O"}}], "cell": [[3, 0, 0], [0, 3, 0], [0, 0, 3]], "descr": {"a": 3.00, "b": 3.00, "c": 3.00, "alpha": 90, "beta": 90, "gamma": 90}, "overlayed": {"m": "atomic ambivalence", "mm": "my test property"}}';

var JmolColors = { "D": "#FFFFC0", "H": "#FFFFFF", "He": "#D9FFFF", "Li": "#CC80FF", "Be": "#C2FF00", "B": "#FFB5B5", "C": "#909090", "N": "#3050F8", "O": "#FF0D0D", "F": "#90E050", "Ne": "#B3E3F5", "Na": "#AB5CF2", "Mg": "#8AFF00", "Al": "#BFA6A6", "Si": "#F0C8A0", "P": "#FF8000", "S": "#FFFF30", "Cl": "#1FF01F", "Ar": "#80D1E3", "K": "#8F40D4", "Ca": "#3DFF00", "Sc": "#E6E6E6", "Ti": "#BFC2C7", "V": "#A6A6AB", "Cr": "#8A99C7", "Mn": "#9C7AC7", "Fe": "#E06633", "Co": "#F090A0", "Ni": "#50D050", "Cu": "#C88033", "Zn": "#7D80B0", "Ga": "#C28F8F", "Ge": "#668F8F", "As": "#BD80E3", "Se": "#FFA100", "Br": "#A62929", "Kr": "#5CB8D1", "Rb": "#702EB0", "Sr": "#00FF00", "Y": "#94FFFF", "Zr": "#94E0E0", "Nb": "#73C2C9", "Mo": "#54B5B5", "Tc": "#3B9E9E", "Ru": "#248F8F", "Rh": "#0A7D8C", "Pd": "#006985", "Ag": "#C0C0C0", "Cd": "#FFD98F", "In": "#A67573", "Sn": "#668080", "Sb": "#9E63B5", "Te": "#D47A00", "I": "#940094", "Xe": "#429EB0", "Cs": "#57178F", "Ba": "#00C900", "La": "#70D4FF", "Ce": "#FFFFC7", "Pr": "#D9FFC7", "Nd": "#C7FFC7", "Pm": "#A3FFC7", "Sm": "#8FFFC7", "Eu": "#61FFC7", "Gd": "#45FFC7", "Tb": "#30FFC7", "Dy": "#1FFFC7", "Ho": "#00FF9C", "Er": "#00E675", "Tm": "#00D452", "Yb": "#00BF38", "Lu": "#00AB24", "Hf": "#4DC2FF", "Ta": "#4DA6FF", "W": "#2194D6", "Re": "#267DAB", "Os": "#266696", "Ir": "#175487", "Pt": "#D0D0E0", "Au": "#FFD123", "Hg": "#B8B8D0", "Tl": "#A6544D", "Pb": "#575961", "Bi": "#9E4FB5", "Po": "#AB5C00", "At": "#754F45", "Rn": "#428296", "Fr": "#420066", "Ra": "#007D00", "Ac": "#70ABFA", "Th": "#00BAFF", "Pa": "#00A1FF", "U": "#008FFF", "Np": "#0080FF", "Pu": "#006BFF", "Am": "#545CF2", "Cm": "#785CE3", "Bk": "#8A4FE3", "Cf": "#A136D4", "Es": "#B31FD4", "Fm": "#B31FBA", "Md": "#B30DA6", "No": "#BD0D87", "Lr": "#C70066", "Rf": "#CC0059", "Db": "#D1004F", "Sg": "#D90045", "Bh": "#E00038", "Hs": "#E6002E", "Mt": "#EB0026" };

var AseRadii = { "X": 0.66, "H": 0.31, "He": 0.28, "Li": 1.28, "Be": 0.96, "B": 0.84, "C": 0.76, "N": 0.71, "O": 0.66, "F": 0.57, "Ne": 0.58, "Na": 1.66, "Mg": 1.41, "Al": 1.21, "Si": 1.11, "P": 1.07, "S": 1.05, "Cl": 1.02, "Ar": 1.06, "K": 2.03, "Ca": 1.76, "Sc": 1.70, "Ti": 1.60, "V": 1.53, "Cr": 1.39, "Mn": 1.39, "Fe": 1.32, "Co": 1.26, "Ni": 1.24, "Cu": 1.32, "Zn": 1.22, "Ga": 1.22, "Ge": 1.20, "As": 1.19, "Se": 1.20, "Br": 1.20, "Kr": 1.16, "Rb": 2.20, "Sr": 1.95, "Y": 1.90, "Zr": 1.75, "Nb": 1.64, "Mo": 1.54, "Tc": 1.47, "Ru": 1.46, "Rh": 1.42, "Pd": 1.39, "Ag": 1.45, "Cd": 1.44, "In": 1.42, "Sn": 1.39, "Sb": 1.39, "Te": 1.38, "I": 1.39, "Xe": 1.40, "Cs": 2.44, "Ba": 2.15, "La": 2.07, "Ce": 2.04, "Pr": 2.03, "Nd": 2.01, "Pm": 1.99, "Sm": 1.98, "Eu": 1.98, "Gd": 1.96, "Tb": 1.94, "Dy": 1.92, "Ho": 1.92, "Er": 1.89, "Tm": 1.90, "Yb": 1.87, "Lu": 1.87, "Hf": 1.75, "Ta": 1.70, "W": 1.62, "Re": 1.51, "Os": 1.44, "Ir": 1.41, "Pt": 1.36, "Au": 1.36, "Hg": 1.32, "Tl": 1.45, "Pb": 1.46, "Bi": 1.48, "Po": 1.40, "At": 1.50, "Rn": 1.50, "Fr": 2.60, "Ra": 2.21, "Ac": 2.15, "Th": 2.06, "Pa": 2.00, "U": 1.96, "Np": 1.90, "Pu": 1.87, "Am": 1.80, "Cm": 1.69, "Bk": 3.0, "Cf": 3.0, "Es": 3.0, "Fm": 3.0, "Md": 3.0, "No": 3.0, "Lr": 3.0, "Rf": 3.0, "Db": 3.0, "Sg": 3.0, "Bh": 3.0, "Hs": 3.0, "Mt": 3.0 }; // NB starting from Bk the data are incorrect

function calc_2D_pos(vector){
    var projector = new THREE.Projector();
    vector = projector.projectVector( new THREE.Vector3( vector.x, vector.y, vector.z ), camera );
    return {
        x: parseInt(document.body.clientWidth/2) + Math.round(vector.x * (renderer.domElement.width/2)),
        y: parseInt(document.body.clientHeight/2) - Math.round(vector.y * (renderer.domElement.height/2))
    };
}

function remove_2D_labels(){ // added to Controls!
    var labels = document.getElementsByClassName('L');
    while (labels[0]){ labels[0].parentNode.removeChild(labels[0]) }
}

function add_2D_labels(){ // added to Controls!
    if (!window.active_overlay.length) return;

    var obj = scene.getObjectByName("atoms3d");
    obj = obj.children;
    var i, len = obj.length;
    for (i = 0; i < len; i++){
        if (obj[i].name == 'atom3d'){
            var p2d = calc_2D_pos(obj[i].position);
            var s = document.createElement('div');
            var c = (window.active_overlay == 'N') ? (i+1) : obj_3D.atoms[i].o[window.active_overlay];
            if (c) s.innerHTML = c;
            else continue;
            s.setAttribute('class', 'L');
            s.style.left = p2d.x + 'px';
            s.style.top = p2d.y + 'px';
            container.appendChild( s );
        }
    }
}

function unit(vec){
    return math.divide(vec, math.norm(vec));
}

function jsobj2player(crystal){

    var pi = 3.141592653589793;
    var ab_norm = [0, 0, 1];
    var a_dir = [1, 0, 0];
    var Z = unit(ab_norm);
    var X = unit( math.subtract( a_dir, math.multiply( math.dot(a_dir, Z), Z ) ) );
    var Y = math.cross(Z, X);
    //console.log("X", X);
    //console.log("Y", Y);
    //console.log("Z", Z);
    var alpha = crystal.cell.alpha * pi/180, beta = crystal.cell.beta * pi/180, gamma = crystal.cell.gamma * pi/180;
    var a = crystal.cell.a, b = crystal.cell.b, c = crystal.cell.c;
    //console.log("alpha", alpha);
    //console.log("beta", beta);
    //console.log("gamma", gamma);
    //console.log("a", a);
    //console.log("b", b);
    //console.log("c", c);
    var va = math.multiply(a, [1, 0, 0]);
    var vb = math.multiply(b, [math.cos(gamma), math.sin(gamma), 0]);
    var cx = math.cos(beta);
    var cy = math.divide( math.subtract( math.cos(alpha), math.multiply( math.cos(beta), math.cos(gamma) ) ), math.sin(gamma) );
    var cz = math.sqrt( math.subtract( math.subtract(1, math.multiply(cx, cx)), math.multiply(cy, cy) ) );
    var vc = math.multiply(c, [cx, cy, cz]);
    //console.log("va", va);
    //console.log("vb", vb);
    //console.log("vc", vc);
    //console.log("cx", cx);
    //console.log("cy", cy);
    //console.log("cz", cz);
    var abc = [va, vb, vc];
    var t = [X, Y, Z];
    //console.log("abc", abc);
    //console.log("t", t);
    var cell = math.dotMultiply(abc, t);
    //console.log("cell", cell);
    var scpositions = [];
    var i, len = crystal.atoms.length;
    for (i = 0; i < len; i++){
        scpositions.push([ crystal.atoms[i].x, crystal.atoms[i].y, crystal.atoms[i].z ]);
    }
    var positions = math.multiply(scpositions, cell);
    //console.log("positions", positions);
    var player_output = {"atoms": [], "cell": cell, "descr": crystal.cell, "overlayed": null};
    var color, radius;
    var i, len = crystal.atoms.length;
    for (i = 0; i < len; i++){
        color = (JmolColors[ crystal.atoms[i].symbol ]) ? JmolColors[ crystal.atoms[i].symbol ] : '0xffff00';
        radius = (AseRadii[ crystal.atoms[i].symbol ]) ? AseRadii[ crystal.atoms[i].symbol ] : 0.66;
        player_output.atoms.push( {"x": positions[i][0], "y": positions[i][1], "z": positions[i][2], "c": color, "r": radius, "o": {"t": crystal.atoms[i].symbol}} )
    }
    //console.log(player_output);
    return player_output;
}

function cif2player(str){
    //var sample = '{"atoms": [{"x": "0", "y": "0", "z": "0", "c": "0x000000", "r": "1.25", "o": {"m": 42, "mm": -0.0022, "t": "Uuo"}}, {"x": "1.25", "y": "1.25", "z": "1.25", "c": "0xFF0000", "r": "1", "o": {"m": 8, "t": "O"}}], "cell": [[3, 0, 0], [0, 3, 0], [0, 0, 3]], "descr": {"a": 3.00, "b": 3.00, "c": 3.00, "alpha": 90, "beta": 90, "gamma": 90}, "overlayed": {"m": "atomic ambivalence", "mm": "my test property"}}';

    var structures = [], data = str.split("\n"), cur_structure = {'cell':{}, 'atoms':[]}, loop_active = false;
    var i=0, s=[], ss=[], new_structure=false;
    var cell_props = ['a', 'b', 'c', 'alpha', 'beta', 'gamma'];
    var atom_vals = ['_atom_site_label', '_atom_site_type_symbol', '_atom_site_fract_x', '_atom_site_fract_y', '_atom_site_fract_z'];
    var atom_props = ['label', 'symbol', 'x', 'y', 'z'];
    var atprop_seq = [];
    var i, len = data.length;
    for (i = 0; i < len; i++){
        if (data[i].startswith('#')) continue;
        data[i] = data[i].toLowerCase().trim();

        if (!data[i]){
            loop_active = false, atprop_seq = [];
            continue;
        }
        //console.log(data[i]);

        new_structure = false;

        if (data[i].startswith('data_')) new_structure = true, loop_active = false, atprop_seq = [];
        else if (data[i].startswith('_cell_')){

            loop_active = false, atprop_seq = [];
            s = data[i].split(" ");
            ss = s[0].split("_");
            var cell_value = ss[ ss.length-1 ];
            if (cell_props.indexOf(cell_value) !== -1 && s[ s.length-1 ]){
                cur_structure.cell[cell_value] = parseFloat(s[ s.length-1 ]);
            }
            continue;

        } else if (data[i].startswith('_symmetry_')){

            loop_active = false, atprop_seq = [];
            continue;
            // todo

        } else if (data[i].startswith('loop_')){
            loop_active = true, atprop_seq = [];
            continue;
        }

        if (loop_active){
            if (data[i].startswith('_')){
                atprop_seq.push(data[i]);
            } else {
                var atom = {};
                s = data[i].split(" ").filter(function(o){ return o ? true : false });
                var j, len2 = atprop_seq.length;
                for (j = 0; j < len2; j++){
                    var atom_index = atom_vals.indexOf(atprop_seq[j]);
                    if (atom_index !== -1 && s[j]){
                        if (['x', 'y', 'z'].indexOf(atom_props[atom_index]) !== -1) s[j] = parseFloat(s[j]);
                        else s[j] = s[j].charAt(0).toUpperCase() + s[j].slice(1);
                        atom[ atom_props[atom_index] ] = s[j];
                    }
                }
                if (atom.x !== undefined && atom.y !== undefined && atom.z !== undefined){ // NB zero coord
                    if (!atom.symbol && !!atom.label) atom.symbol = atom.label.replace(/[0-9]/g, '');
                    if (!JmolColors[atom.symbol] && atom.symbol.length > 2) atom.symbol = atom.symbol.substr(0, atom.symbol.length-1);
                    if (!JmolColors[atom.symbol] && atom.symbol.length > 1) atom.symbol = atom.symbol.substr(0, atom.symbol.length-1);
                    if (!!atom.symbol) cur_structure.atoms.push(atom);
                }
            }
            continue;
        }

        if (new_structure && cur_structure.atoms.length){
            structures.push(cur_structure);
            cur_structure = {'cell':{}, 'atoms':[]};
        }
    }
    if (cur_structure.atoms.length) structures.push(cur_structure);
    //console.log(structures);

    if (structures.length) return jsobj2player(structures[ structures.length-1 ]);
    else return false;
}

function draw_3d_line(start_arr, finish_arr, color){
    if (!color) var color = 0x999999;
    var vector = new THREE.Geometry();
    vector.vertices.push(new THREE.Vector3( start_arr[0], start_arr[1], start_arr[2] ));
    vector.vertices.push(new THREE.Vector3( finish_arr[0], finish_arr[1], finish_arr[2] ));
    var material = new THREE.LineBasicMaterial({color: color});
    atoms.add(new THREE.Line(vector, material));
}

function render_3D(){
    var old = scene.getObjectByName("atoms3d");
    if (!!old) scene.remove( old );
    atoms = new THREE.Object3D();

    //obj_3D = obj_3D || sample;
    //obj_3D = JSON.parse(obj_3D);

    if (obj_3D.descr && 'a' in obj_3D.descr){
        var descr = obj_3D.descr;
        var test = document.getElementById('infopanel');
        if (!!test) test.parentNode.removeChild(test);
        var infopanel = document.createElement('div');
        infopanel.setAttribute('id', 'infopanel');
        infopanel.innerHTML = '<span style=color:#900>a = '+descr['a']+' &#8491;</span><br /><span style=color:#090>b = '+descr['b']+' &#8491;</span><br /><span style=color:#009>c = '+descr['c']+' &#8491;</span><br />&#945; = '+descr['alpha']+'&deg;<br />&#946; = '+descr['beta']+'&deg;<br />&#947; = '+descr['gamma']+'&deg;<br />';
        container.appendChild( infopanel );
    }

    var test = document.getElementById('optionpanel');
    if (!!test) { test.parentNode.removeChild(test); remove_2D_labels(); }
    var optionpanel = document.createElement('div');
    optionpanel.setAttribute('id', 'optionpanel');
    optionpanel.innerHTML = '<input type=radio name=optionpanel id=optionpanel_ checked=true /><label for=optionpanel_>none</label>';
    optionpanel.innerHTML += ' <input type=radio name=optionpanel id=optionpanel_t /><label for=optionpanel_t>elements</label>';
    optionpanel.innerHTML += ' <input type=radio name=optionpanel id=optionpanel_N /><label for=optionpanel_N>id\'s</label>';
    if (obj_3D.overlayed){
        for (var prop in obj_3D.overlayed){
            optionpanel.innerHTML += ' <input type=radio name=optionpanel id=optionpanel_'+prop+' /><label for=optionpanel_'+prop+'>'+obj_3D.overlayed[prop]+'</label>';
        }
    }
    container.appendChild( optionpanel );
    optionpanel.onclick = function(e){
        remove_2D_labels();
        if (!e) e = window.event;
        window.active_overlay = (e.target || e.srcElement).id.replace('optionpanel_', '');
        if (window.active_overlay.length) add_2D_labels();
    }

    var actd, sphd = {lodim:{w:6, h:6}, hidim:{w:10, h:8}};
    obj_3D.atoms.length > 50 ? actd = sphd.lodim : actd = sphd.hidim;

    var i, len = obj_3D.atoms.length;
    for (i = 0; i < len; i++){
        var atom = new THREE.Mesh( new THREE.SphereGeometry( obj_3D.atoms[i].r*40, actd.w, actd.h ), new THREE.MeshLambertMaterial( { color: obj_3D.atoms[i].c, shading: THREE.FlatShading, overdraw: 0.25 } ) );
        atom.position.x = parseInt( obj_3D.atoms[i].x*100 );
        atom.position.y = parseInt( obj_3D.atoms[i].y*100 );
        atom.position.z = parseInt( obj_3D.atoms[i].z*100 );
        atom.name = "atom3d";
        atoms.add(atom);
    }
    if (obj_3D.cell.length){
        var tempcolor, ortes = [];
        for (var i = 0; i < 3; i++){
            var a = Math.round(parseFloat(obj_3D.cell[i][0])*1000)/10;
            var b = Math.round(parseFloat(obj_3D.cell[i][1])*1000)/10;
            var c = Math.round(parseFloat(obj_3D.cell[i][2])*1000)/10;
            ortes.push([a, b, c]);
            var trans_vector = new THREE.Geometry();
            trans_vector.vertices.push(new THREE.Vector3(0, 0, 0));
            trans_vector.vertices.push(new THREE.Vector3( a, b, c ));
            if (i==0) tempcolor = 0x990000;
            if (i==1) tempcolor = 0x009900;
            if (i==2) tempcolor = 0x000099;
            atoms.add(new THREE.Line(trans_vector, new THREE.LineBasicMaterial({color: tempcolor })));
        }

        var material = new THREE.LineBasicMaterial({color: 0xCCCCCC });
        var plane_point1 = [ortes[0][0]+ortes[1][0], ortes[0][1]+ortes[1][1], ortes[0][2]+ortes[1][2]]
        var plane_point2 = [ortes[0][0]+ortes[2][0], ortes[0][1]+ortes[2][1], ortes[0][2]+ortes[2][2]]
        var plane_point3 = [plane_point1[0]+ortes[2][0], plane_point1[1]+ortes[2][1], plane_point1[2]+ortes[2][2]]
        var dpoint = [ortes[1][0]+ortes[2][0], ortes[1][1]+ortes[2][1], ortes[1][2]+ortes[2][2]]
        var drawing_cell = [];

        drawing_cell.push([ortes[0], plane_point1]);
        drawing_cell.push([ortes[0], plane_point2]);
        drawing_cell.push([ortes[1], dpoint]);
        drawing_cell.push([ortes[1], plane_point1]);
        drawing_cell.push([ortes[2], dpoint]);
        drawing_cell.push([ortes[2], plane_point2]);
        drawing_cell.push([plane_point1, plane_point3]);
        drawing_cell.push([plane_point2, plane_point3]);
        drawing_cell.push([plane_point3, dpoint]);

        var i, len = drawing_cell.length;
        for (i = 0; i < len; i++){
            draw_3d_line(drawing_cell[i][0], drawing_cell[i][1]);
        }
    }
    atoms.name = "atoms3d";
    scene.add(atoms);
    TWEEN.removeAll();
    vivify();

    //var fake_phonon = ''; for (var i=0; i<obj_3D.atoms.length; i++){ fake_phonon += '1,1,1, ' } // debug phonon animation
    //vibrate_3D( '[' + fake_phonon.substr(0, fake_phonon.length-2) + ']' );
}

function vibrate_3D(objPH){

    TWEEN.removeAll();

    if (objPH) {
        // displace atoms
        objPH = JSON.parse(objPH);
        //if (objPH.length/3 !== obj_3D.atoms.length) console.log('Internal atomic inconsistency error!');

        remove_2D_labels();
        var i, len = objPH.length/3;
        for (i = 0; i < len; i++){
            var x = parseInt( obj_3D.atoms[i].x*100 );
            var y = parseInt( obj_3D.atoms[i].y*100 );
            var z = parseInt( obj_3D.atoms[i].z*100 );
            var distb_pos = { x: x + objPH[i*3]*200, y: y + objPH[i*3+1]*200, z: z + objPH[i*3+2]*200 };
            var tweenHead = new TWEEN.Tween( atoms.children[i].position ).to(distb_pos, 750).repeat(Infinity).delay(500).yoyo(true).start();
        }

        window.active_tween = true;
        if (!window.active_renderer) window.active_renderer = requestAnimationFrame(vivify);

        window.overlay_backup = window.active_overlay;
        window.active_overlay = "";
    } else {
        // return atoms back
        var i, len = obj_3D.atoms.length;
        for (i = 0; i < len; i++){
            var x = parseInt( obj_3D.atoms[i].x*100 );
            var y = parseInt( obj_3D.atoms[i].y*100 );
            var z = parseInt( obj_3D.atoms[i].z*100 );
            var equil_pos = { x: x, y: y, z: z };
            var tweenBack = new TWEEN.Tween( atoms.children[i].position ).to(equil_pos, 750).start();
            if (i==len-1) tweenBack.onComplete(function(){ cancelAnimationFrame(window.active_renderer); window.active_tween = false; }); // we need to cancel rendering in order to save CPU
        }
        window.active_overlay = window.overlay_backup;
        add_2D_labels();
    }
}

function init_3D(){
    loaded_3D = true;

    container = document.createElement('div');
    container.style.backgroundColor = '#ffffff';
    document.body.appendChild( container );

    scene = new THREE.Scene();
    camera = new THREE.OrthographicCamera( -window.innerWidth*1.5, window.innerWidth*1.5, -window.innerHeight*1.5, window.innerHeight*1.5, -2000, 2000 );
    camera.position.set(0, 0, 1);
    scene.add(camera);

    var AmbientLight = new THREE.AmbientLight( 0x999999 );
    scene.add( AmbientLight );
    var PointLight = new THREE.PointLight( 0x666666, 1 );
    PointLight.position = camera.position;
    scene.add( PointLight );

    renderer = new THREE.CanvasRenderer();
    renderer.setClearColor( 0xffffff, 1 );
    renderer.setSize( window.innerWidth, window.innerHeight );
    container.appendChild( renderer.domElement );

    //stats = new Stats();
    //stats.domElement.style.position = 'absolute';
    //stats.domElement.style.top = '0px';
    //container.appendChild( stats.domElement );

    var zoompanel = document.createElement('div');
    zoompanel.setAttribute('id', 'zoompanel');
    container.appendChild( zoompanel );
    zoompanel.onclick = function(e){
        if (!e) e = window.event;
        if (e.cancelBubble) e.cancelBubble = true;
        else e.stopPropagation();
        var y = (e.pageY) ? e.pageY : e.clientY;
        if (y<44){
            /*var uri = document.location.hash.substr(1).split('/');
            if (uri.length == 2){
                if (!!window.parent._gui) window.open('/static/#' + uri[0] + '/' + uri[1]);
                else self.close();
            }*/
            return;
        }
        var fov = (y > 99) ? -100 : 100, c = window.innerHeight/window.innerWidth;
        camera.left += fov;
        camera.right -= fov;
        camera.top += fov*c;
        camera.bottom -= fov*c;
        camera.updateProjectionMatrix();
    }

    controls = new THREE.TrackballControls( camera );
    controls.staticMoving = true;
    render_3D();
}

function vivify(){
    if (!!window.active_renderer) requestAnimationFrame(vivify);
    renderer.render(scene, camera);
    controls.update();
    TWEEN.update();
    //stats.update();
}

function rescale(event){
    var fov = -((event.wheelDelta) ? event.wheelDelta/120 : event.detail/-3) * 100, c = window.innerHeight/window.innerWidth;
    camera.left += fov;
    camera.right -= fov;
    camera.top += fov*c;
    camera.bottom -= fov*c;
    camera.updateProjectionMatrix();
    remove_2D_labels();
    add_2D_labels();
    vivify();
    event.preventDefault();
    event.stopPropagation();
}

/*function iframe_download( request, scope, hash ){
    var dl = document.createElement( 'form' );
    dl.method = "GET";
    dl.action = '/' + request + '/' + scope + '/' + hash;
    dl.target = "file-process";
    dl.style.display = "none";
    document.body.appendChild(dl);
    dl.submit();
}*/

function url_redraw_react(){
    //var uri = document.location.hash.substr(1).split('/');
    //if (uri.length == 2 || uri.length == 3) json_download( 'json3d/' + uri.join('/') );

    var t = document.location.hash.substr(1);
    file_download(t);
}

/*function json_download(request){
    var xmlhttp = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
    xmlhttp.onreadystatechange = function(){
        if ((xmlhttp.readyState == 4) && (xmlhttp.status == 200)){
            obj_3D = xmlhttp.responseText;
            loaded_3D ? render_3D() : init_3D();
        }
    }
    xmlhttp.open("GET", '/' + request);
    xmlhttp.setRequestHeader("If-Modified-Since", "Sat, 1 Jan 2000 00:00:00 GMT");
    xmlhttp.send(1);
}*/

function file_download(url){
    if (url.indexOf('://') == -1) return;
    var parser = document.createElement('a');
    parser.href = url;
    if (parser.hostname !== window.location.hostname){
        url = '/proxy.php?url=' + url;
    }

    var xmlhttp = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
    xmlhttp.onreadystatechange = function(){
        if (xmlhttp.readyState == 4){
            if (xmlhttp.status == 200){
                obj_3D = xmlhttp.responseText || "";
                accept_data();
            } else alert("Error: HTTP " + xmlhttp.status + " status received during retrieving data from the server");
        }
    }
    xmlhttp.open("GET", url);
    xmlhttp.setRequestHeader("If-Modified-Since", "Sat, 1 Jan 2000 00:00:00 GMT");
    xmlhttp.send(1);
}

function accept_data(){
    //console.log("Contents follow:", obj_3D);

    if (obj_3D.indexOf("_cell_length_a ") > -1){
        obj_3D = cif2player(obj_3D);
        if (!obj_3D) return alert("Error: received file has invalid format!");
    } else {
        return alert("Error: received file format is not supported!");
    }

    loaded_3D ? render_3D() : init_3D();
}

function handleFileSelect(evt){
    evt.stopPropagation();
    evt.preventDefault();

    if (evt.dataTransfer.files.length > 1) return alert("Error: only one file at the time may be rendered!");
    var file = evt.dataTransfer.files[0];
    if (!file || !file.size) return alert("Error: file cannot be read (unaccessible?)");

    var reader = new FileReader();

    reader.onloadend = function(evt){
        obj_3D = evt.target.result;
        accept_data();
    }
    reader.abort = function(){ alert("Error: file reading has been cancelled!") }
    reader.onerror = function(evt){ alert("Error: file reading has been cancelled: " + evt.target.error.name) }

    reader.readAsText(file);
}

function handleDragOver(evt){
    evt.stopPropagation();
    evt.preventDefault();
    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy
    //console.log("Ready...");
}

window.onload = function(){
    if (!window.location.protocol.startswith('http')){
        return alert('Error: this page must be served by a PHP- or Python-enabled web server');
    }

    window.addEventListener('DOMMouseScroll', rescale, false);
    window.addEventListener('mousewheel', rescale, false);
    window.addEventListener('hashchange', url_redraw_react, false);
    window.addEventListener('resize', function(){
        // todo
        renderer.setSize( window.innerWidth, window.innerHeight );
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        vivify();
    }, false);
    if (window.FileReader){
        window.addEventListener('dragover', handleDragOver, false);
        window.addEventListener('drop', handleFileSelect, false);
    }

    /*if (document.location.hash.length){
        var uri = document.location.hash.substr(1).split('/');
        if (uri.length == 2 || uri.length == 3) json_download( 'json3d/' + uri.join('/') );
    } else init_3D();*/

    if (document.location.hash.length) url_redraw_react();
    else document.location.hash = '#http://www.nwchem-sw.org/images/Diamond.opt.cif';
    //else file_download(window.location.protocol + '//' + window.location.hostname + ':' + window.location.port + '/test.cif');
}
</script>
</body>
</html>
